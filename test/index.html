<!doctype html>
<html>
<head>
<title>test</title>
<script src="require.js"></script>
<script src="stats.min.js"></script>
<style>
.box {
	display: inline-block;
	border: 1px solid black;
	width: 10px;
	height: 10px;
}
</style>
</head>
<body>
<h1>DOMShader w/ mutable pipeline</h1>
<button onclick="addMore()">Add 100 squares</button>
<section></section>
<script>
var section = document.querySelector('section');
section.style.position = "relative";

function addMore() {
	var box, i;
	for (i = 0; i < 100; ++i) {
		box = document.createElement('div');
		box.className = "box";
		section.appendChild(box);
	}
}

</script>
<script>
require.config({
	baseUrl: '..',
	paths: {
		mori: 'node_modules/mori/mori',
		specificity: 'node_modules/specificity/specificity',
		nbd: 'node_modules/nbd'
	},
	shim: {
		specificity: {
			exports: 'SPECIFICITY'
		}
	}
});

require(['lib/Selectors', 'lib/CSSPipeline'], function(Selectors, Pipeline) {
	var blat = {
		count: 0,
		d: 30,
		main: function(input) {
			this.count++;
			if (this.count >= Math.pow(this.d, 2)) {
				this.count -= Math.pow(this.d, 2);
			}
			var col = this.count % this.d,
				row = this.count / this.d | 0,
				c = (this.d-1)/2,
				r = Math.sqrt(Math.pow(c - col, 2) + Math.pow(c - row, 2));
			r *= input.factor;
			return {
				backgroundColor: 'hsl('+(r%360)+', 100%, 70%)',
				transform: 'rotate('+r+'deg)',
				position: 'absolute',
				left: col * 20 + 'px',
				top: row * 20 + 'px'
			};
		}
	};

	var pipe = new Pipeline();
	pipe.push(blat);

	var stats = new Stats();
	stats.setMode(0); // 0: fps, 1: ms
	stats.domElement.style.position = 'absolute';
	stats.domElement.style.right = '0px';
	stats.domElement.style.top = '0px';
	document.body.appendChild(stats.domElement);


	function apply(mutations) {
		mutations.forEach(function(mutation) {
			if (!(mutation.addedNodes.length || mutation.removedNodes.length)) {
				return;
			}

			var i;
			for (i = 0; i < mutation.addedNodes.length; ++i) {
				Selectors.added(mutation.addedNodes[i]);
			}
			for (i = 0; i < mutation.removedNodes.length; ++i) {
				Selectors.removed(mutation.removedNodes[i]);
			}
		});
	}

	function watch(target) {
		var observer = new MutationObserver(apply);
		observer.observe(target, {
			childList: true,
			attributes: false,
			characterData: false,
			subtree: true
		});
	}

	watch(document.querySelector('section'));

	var frame = 0;
	setInterval(function() {
		stats.begin();

		var value = Math.sin(frame++ / 30) * 30;
		pipe.process(Selectors.get('.box'), {
			factor: value
		});

		stats.end();
	}, 1000 / 60);
});
</script>
</body>
</html>
